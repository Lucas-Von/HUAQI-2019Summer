<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="financial_management.data.property.EstateMapper">

    <select id="getPropertyByUser" resultMap="EstatePO">
        select
            coalesce(sum(mf.balance), 0) as fundsInPlatform,
            coalesce(q.funds, 0) as fundsOutPlatform,
            coalesce(sum(md.amount), 0) as savingInPlatform,
            coalesce(q.saving, 0) as savingOutPlatform,
            coalesce(sum(mi.price), 0) as insuranceInPlatform,
            coalesce(q.insurance, 0) as insuranceOutPlatform,
            coalesce(sum(ms.hold_total), 0) as stocksInPlatform,
            coalesce(q.stocks, 0) as stocksOutPlatform,
            coalesce(sum(mq.hold_total), 0) as qdiiInPlatform,
            coalesce(q.stocks, 0) as qdiiOutPlatform,
            coalesce(sum(mg.sum), 0) as goldInPlatform,
            coalesce(q.gold, 0) as goldOutPlatform,
            coalesce(sum(ubf.fund_share * ubf.net_worth), 0) as bondInPlatform,
            coalesce(q.bond, 0) as bondOutPlatform
        from questionnaire q
            left join my_fund mf on mf.user_id = q.user_id
            left join my_depo md on md.user_id = q.user_id
            left join my_ins mi on mi.user_id = q.user_id
            left join my_qdii mq on mq.user_id = q.user_id
            left join my_stock ms on ms.user_id = q.user_id
            left join my_gold mg on mg.user_id = q.user_id
            left join user_bond_fund ubf on ubf.user_id = q.user_id
        where q.user_id = #{userId};
    </select>

    <select id="getMonthlyProList" resultMap="FortunePO">
        select user_id as userId, record_date as recordDate, funds, saving, insurance, stocks, qdii, gold, bond
        from fortune
        where user_id = #{userId} and record_date REGEXP "01$";
    </select>

    <select id="getMonthlyInvList" resultMap="InvestPO">
        select user_id as userId, record_date as recordDate, stocks, qdii, gold, bond
        from fortune
        where user_id = #{userId} and record_date REGEXP "01$";
    </select>

    <select id="getDailyProList" resultMap="FortunePO">
        select user_id as userId, record_date as recordDate, funds, saving, insurance, stocks, qdii, gold, bond
        from fortune
        where user_id = #{userId} and DATE_SUB(CURDATE(), INTERVAL 30 DAY);
    </select>

    <select id="getDailyInvList" resultMap="InvestPO">
        select user_id as userId, record_date as recordDate, stocks, qdii, gold, bond
        from fortune
        where user_id = #{userId} and DATE_SUB(CURDATE(), INTERVAL 30 DAY);
    </select>

    <select id="getCompleteProList" resultMap="FortunePO">
        select user_id as userId, record_date as recordDate, funds, saving, insurance, stocks, qdii, gold, bond
        from fortune
        where user_id = #{userId}
    </select>

    <select id="getFortuneUpdateTime" resultType="date">
        select Max(record_date) from fortune where user_id = #{userId}
    </select>

    <insert id="updateFortuneByDay">
        insert into fortune(user_id, record_date, funds, saving, insurance, stocks, gold, bond, qdii)
        select
            u.user_id,
            CURDATE(),
            coalesce(sum(mf.balance), 0),
            coalesce(sum(md.amount), 0),
            coalesce(sum(mi.price), 0),
            coalesce(sum(ms.hold_total), 0),
            coalesce(sum(mg.sum), 0),
            coalesce(sum(ubf.fund_share * ubf.net_worth), 0),
            coalesce(sum(mq.hold_total), 0)
        from user u
            left join my_fund mf on mf.user_id = u.user_id
            left join my_depo md on md.user_id = u.user_id
            left join my_ins mi on mi.user_id = u.user_id
            left join my_stock ms on ms.user_id = u.user_id
            left join my_gold mg on mg.user_id = u.user_id
            left join user_bond_fund ubf on ubf.user_id = u.user_id
            left join my_qdii mq on mq.user_id = u.user_id
        where u.user_id != 0
        group by u.user_id
    </insert>

    <select id="getTotalIncome" resultType="Double">
        select coalesce(sum(ms.profit), 0) + coalesce(sum(mq.profit), 0) + coalesce(sum(mg.profit), 0) + coalesce(sum(ubf.fund_share * ubf.net_worth - ubf.inject), 0)
        from my_stock ms
            left join my_qdii mq on mq.user_id = ms.user_id
            left join my_gold mg on mg.user_id = ms.user_id
            left join user_bond_fund ubf on ubf.user_id = ms.user_id
        where ms.user_id = #{userId};
    </select>

    <select id="getNewlyIncome" resultMap="RecentInvPO">
        select
            coalesce(f.stocks, 0) as yesterdayStocks,
            coalesce(f.qdii, 0) as yesterdayQdii,
            coalesce(f.gold, 0) as yesterdayGold,
            coalesce(f.bond, 0) as yesterdayBond,
            coalesce(sum(ms.hold_total), 0) as currentStocks,
            coalesce(sum(mq.hold_total), 0) as currentQdii,
            coalesce(sum(mg.sum), 0) as currentGold,
            coalesce(sum(ubf.fund_share * ubf.net_worth), 0) as currentBond
        from fortune f
            left join my_stock ms on ms.user_id = f.user_id
            left join my_gold mg on mg.user_id = f.user_id
            left join user_bond_fund ubf on ubf.user_id = f.user_id
            left join my_qdii mq on mq.user_id = f.user_id
        where f.user_id = #{userId} and f.record_date = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
    </select>

    <select id="getTotalInvestRate" resultMap="TotalIncomePO">
        select
            coalesce(sum(ms.hold_total), 0) as totalStocks,
            coalesce(sum(mq.hold_total), 0) as totalQdii,
            coalesce(sum(mg.sum), 0) as totalGold,
            coalesce(sum(ubf.fund_share * ubf.net_worth), 0) as totalBond
        from my_stock ms
            left join my_qdii mq on mq.user_id = ms.user_id
            left join my_gold mg on mg.user_id = ms.user_id
            left join user_bond_fund ubf on ubf.user_id = ms.user_id
        where ms.user_id = #{userId};
    </select>

    <select id="ifExistDaysBondLog" resultType="boolean">
        select (count(fund_id) >= #{days}) from bond_rate_log where time = DATE_SUB(CURDATE(), INTERVAL #{days} DAY) and fund_id = #{bondId}
    </select>

    <select id="getBondProfitOfDays" resultMap="BondIncomePO">
        select
            today.net_worth as todayNetWorth,
            beforeDays.net_worth as beforeDaysNetWorth
        from
            (select net_worth form bond_rate_log where time = CURDATE() and fund_id = #{bondId}) today,
            (select net_worth form bond_rate_log where time = DATE_SUB(CURDATE(), INTERVAL #{days} DAY) and fund_id = #{bondId}) beforeDays
    </select>

    <resultMap id="EstatePO" type="financial_management.entity.property.EstatePO">
    </resultMap>

    <resultMap id="DepositPO" type="financial_management.entity.property.DepositPO">
    </resultMap>

    <resultMap id="FortunePO" type="financial_management.entity.property.FortunePO">
    </resultMap>

    <resultMap id="InvestPO" type="financial_management.entity.property.InvestPO">
    </resultMap>

    <resultMap id="RecentInvPO" type="financial_management.entity.property.RecentInvPO">
    </resultMap>

    <resultMap id="TotalIncomePO" type="financial_management.entity.property.TotalIncomePO">
    </resultMap>

    <resultMap id="BondIncomePO" type="financial_management.entity.property.BondIncomePO">
    </resultMap>

</mapper>