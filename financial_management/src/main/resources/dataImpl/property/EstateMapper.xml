<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="financial_management.data.property.EstateMapper">

    <select id="getPropertyByUser" resultMap="EstatePO">
        select
            coalesce(sum(mf.balance), 0) as fundsInPlatform,
            coalesce(q.funds, 0) as fundsOutPlatform,
            coalesce(sum(md.amount), 0) as savingInPlatform,
            coalesce(q.saving, 0) as savingOutPlatform,
            coalesce(sum(mi.price), 0) as insuranceInPlatform,
            coalesce(q.insurance, 0) as insuranceOutPlatform,
            coalesce(sum(ms.purchase_price), 0) as stocksInPlatform,
            coalesce(q.stocks, 0) as stocksOutPlatform,
            coalesce(sum(mq.purchase_price), 0) as qdiiInPlatform,
            coalesce(q.stocks, 0) as qdiiOutPlatform,
            coalesce(sum(mg.sum), 0) as goldInPlatform,
            coalesce(q.gold, 0) as goldOutPlatform,
            coalesce(sum(mb.amount), 0) as bondInPlatform,
            coalesce(q.bond, 0) as bondOutPlatform
        from questionnaire q
            left join my_fund mf on mf.user_id = q.user_id
            left join my_depo md on md.user_id = q.user_id
            left join my_ins mi on mi.user_id = q.user_id
            left join my_qdii mq on mq.user_id = q.user_id
            left join my_stock ms on ms.user_id = q.user_id
            left join my_gold mg on mg.user_id = q.user_id
            left join my_bond mb on mb.user_id = q.user_id
        where q.user_id = #{userId};
    </select>

    <select id="getTotalIncome" resultType="Double">
        select coalesce(sum(ms.profit + mq.profit + mg.profit + mb.profit), 0)
        from my_stock ms
            left join my_qdii mq on mq.user_id = ms.user_id
            left join my_gold mg on mg.user_id = ms.user_id
            left join my_bond mb on mb.user_id = ms.user_id
        where ms.user_id = #{userId};
    </select>

    <select id="getNewlyIncome" resultMap="RecentInvPO">
        select
            coalesce(yesterday.stocks, 0) as yesterdayStocks,
            coalesce(yesterday.qdii, 0) as yesterdayQdii,
            coalesce(yesterday.gold, 0) as yesterdayGold,
            coalesce(yesterday.bond, 0) as yesterdayBond,
            coalesce(dayBeforeYesterday.stocks, 0) as dayBeforeYesterdayStocks,
            coalesce(dayBeforeYesterday.qdii, 0) as dayBeforeYesterdayQdii,
            coalesce(dayBeforeYesterday.gold, 0) as dayBeforeYesterdayGold,
            coalesce(dayBeforeYesterday.bond, 0) as dayBeforeYesterdayBond
        from
            (select stocks, qdii, gold, bond
                from fortune
                where user_id = #{userId} and record_date = DATE_SUB(CURDATE(), INTERVAL 1 DAY)) yesterday,
            (select stocks, qdii, gold, bond
                from fortune
                where user_id = #{userId} and record_date = DATE_SUB(CURDATE(), INTERVAL 2 DAY)) dayBeforeYesterday
    </select>

    <select id="getMonthlyProList" resultMap="FortunePO">
        select user_id as userId, record_date as recordDate, funds, saving, insurance, stocks, qdii, gold, bond
        from fortune
        where user_id = #{userId} and record_date REGEXP "01$";
    </select>

    <select id="getMonthlyInvList" resultMap="InvestPO">
        select user_id as userId, record_date as recordDate, stocks, qdii, gold, bond
        from fortune
        where user_id = #{userId} and record_date REGEXP "01$";
    </select>

    <select id="getDailyProList" resultMap="FortunePO">
        select user_id as userId, record_date as recordDate, funds, saving, insurance, stocks, qdii, gold, bond
        from fortune
        where user_id = #{userId} and DATE_SUB(CURDATE(), INTERVAL 30 DAY);
    </select>

    <select id="getDailyInvList" resultMap="InvestPO">
        select user_id as userId, record_date as recordDate, stocks, qdii, gold, bond
        from fortune
        where user_id = #{userId} and DATE_SUB(CURDATE(), INTERVAL 30 DAY);
    </select>

    <select id="getCompleteProList" resultMap="FortunePO">
        select user_id as userId, record_date as recordDate, funds, saving, insurance, stocks, qdii, gold, bond
        from fortune
        where user_id = #{userId}
    </select>

    <select id="getFortuneUpdateTime" resultType="date">
        select Max(record_date) from fortune where user_id = #{userId}
    </select>

    <resultMap id="EstatePO" type="financial_management.entity.property.EstatePO">
    </resultMap>

    <resultMap id="RecentInvPO" type="financial_management.entity.property.RecentInvPO">
    </resultMap>

    <resultMap id="DepositPO" type="financial_management.entity.property.DepositPO">
    </resultMap>

    <resultMap id="FortunePO" type="financial_management.entity.property.FortunePO">
    </resultMap>

    <resultMap id="InvestPO" type="financial_management.entity.property.InvestPO">
    </resultMap>

</mapper>